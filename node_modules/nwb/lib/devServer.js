'use strict';

exports.__esModule = true;
exports['default'] = server;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _connectHistoryApiFallback = require('connect-history-api-fallback');

var _connectHistoryApiFallback2 = _interopRequireDefault(_connectHistoryApiFallback);

var _express = require('express');

var _express2 = _interopRequireDefault(_express);

var _webpack = require('webpack');

var _webpack2 = _interopRequireDefault(_webpack);

var _colours = require('./colours');

/**
 * Start an express server which uses webpack-dev-middleware to build and serve
 * assets using Webpack's watch mode, and webpack-hot-middleware to hot reload
 * changes in the browser.
 *
 * If static path config is provided, express will serve static content from it.
 */

function server(webpackConfig, _ref, cb) {
  var fallback = _ref.fallback;
  var host = _ref.host;
  var noInfo = _ref.noInfo;
  var port = _ref.port;
  var staticPath = _ref.staticPath;

  var app = _express2['default']();
  var compiler = _webpack2['default'](webpackConfig);

  if (fallback) {
    app.use(_connectHistoryApiFallback2['default']());
  }

  app.use(require('webpack-dev-middleware')(compiler, {
    noInfo: noInfo,
    publicPath: webpackConfig.output.publicPath,
    stats: {
      colors: true
    }
  }));

  app.use(require('webpack-hot-middleware')(compiler));

  if (staticPath) {
    app.use(_express2['default']['static'](staticPath));
  }

  app.listen(port, host, function (err) {
    if (err) return cb(err);
    console.log(_colours.green('nwb: dev server listening at http://' + host + ':' + port));
    console.log('webpack building...');
  });
}

module.exports = exports['default'];